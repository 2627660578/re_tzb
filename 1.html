<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>DocuCraft - 智能公文生成</title>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style type="text/tailwindcss">
        :root {
            --primary-color: #0c7ff2;
            --secondary-color: #e7edf4;
            --text-primary: #0d141c;
            --text-secondary: #49739c;
            --background-color: #f8fafc;
            --input-border-color: #cedbe8;
            --input-focus-border-color: #0c7ff2;
            --success-color: #22c55e;
            --error-color: #ef4444;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        /* 拖拽区域高亮 */
        .drag-over {
            @apply border-2 border-dashed border-[var(--primary-color)] bg-blue-50;
        }
        /* 文件上传列表动画 */
        .file-item {
            transition: all 0.3s ease-in-out;
        }
        /* 加载动画 */
        .loader {
            width: 50px;
            aspect-ratio: 1;
            border-radius: 50%;
            border: 8px solid;
            border-color: #d1d5db #0000;
            animation: l1 1s infinite;
        }
        @keyframes l1 {
            to {
                transform: rotate(.5turn)
            }
        }
        /* 进度条 */
        .progress-bar-bg {
            @apply w-full bg-gray-200 rounded-full h-1.5;
        }
        .progress-bar {
            @apply bg-[var(--primary-color)] h-1.5 rounded-full transition-all duration-300;
        }
    </style>
</head>

<body class="bg-[var(--background-color)] text-[var(--text-primary)]">
    <div class="flex flex-col min-h-screen">
        <!-- 头部导航 -->
        <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-[var(--secondary-color)]">
            <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-3">
                        <div class="text-[var(--primary-color)]">
                            <svg class="h-7 w-7" fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                                <path d="M6 6H42L36 24L42 42H6L12 24L6 6Z" fill="currentColor"></path>
                            </svg>
                        </div>
                        <h1 class="text-lg font-bold tracking-tight">DocuCraft</h1>
                    </div>
                    <div class="hidden md:flex items-center gap-8">
                        <a class="text-sm font-medium text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors"
                            href="#">首页</a>
                        <a class="text-sm font-medium text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors"
                            href="#">模板</a>
                        <a class="text-sm font-medium text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors"
                            href="#">定价</a>
                        <a class="text-sm font-medium text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors"
                            href="#">联系我们</a>
                    </div>
                    <div class="flex items-center gap-4">
                        <button
                            class="hidden sm:flex min-w-[84px] items-center justify-center overflow-hidden rounded-md h-9 px-4 bg-[var(--primary-color)] text-white text-sm font-bold shadow-sm hover:bg-opacity-90 transition-colors">
                            <span class="truncate">新文档</span>
                        </button>
                        <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-9"
                            style='background-image: url("https://placehold.co/40x40/e7edf4/49739c?text=U");'></div>
                    </div>
                </div>
            </nav>
        </header>

        <!-- 主内容区域 -->
        <main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-10">
            <div class="max-w-2xl mx-auto">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold tracking-tight text-[var(--text-primary)] sm:text-4xl">智能生成您的公文</h2>
                    <p class="mt-3 text-base text-[var(--text-secondary)]">填写以下表单，快速生成专业公文清单。</p>
                </div>
                <div class="bg-white p-6 sm:p-8 rounded-lg shadow-md border border-[var(--secondary-color)]">
                    <form class="space-y-6" id="main-form">
                        <div>
                            <label class="block text-sm font-medium text-[var(--text-primary)] mb-1.5"
                                for="document-type">公文类型</label>
                            <select
                                class="form-select block w-full rounded-md border-[var(--input-border-color)] shadow-sm focus:border-[var(--input-focus-border-color)] focus:ring focus:ring-[var(--input-focus-border-color)] focus:ring-opacity-50 transition p-3 bg-white text-base"
                                id="document-type" name="document-type">
                                <option value="">请选择公文类型</option>
                                <option>通知</option>
                                <option>通告</option>
                                <option>通报</option>
                                <option>报告</option>
                                <option>请示</option>
                                <option>批复</option>
                                <option>决议</option>
                                <option>决定</option>
                                <option>公告</option>
                                <option>意见</option>
                                <option>函</option>
                                <option>会议纪要</option>
                                <option>命令（令）</option>
                                <option>议案</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-[var(--text-primary)] mb-1.5"
                                for="requests">生成要求</label>
                            <textarea
                                class="block w-full rounded-md border-[var(--input-border-color)] shadow-sm focus:border-[var(--input-focus-border-color)] focus:ring focus:ring-[var(--input-focus-border-color)] focus:ring-opacity-50 transition p-3 placeholder:text-gray-400 text-base"
                                id="requests" name="requests" placeholder="例如：语气严肃正式，突出会议的重要性..." rows="4"></textarea>
                        </div>
                        <div id="drop-zone-wrapper">
                            <label class="block text-sm font-medium text-[var(--text-primary)] mb-1.5"
                                for="information">现有信息</label>
                            <div id="drop-zone"
                                class="relative p-4 border-2 border-dashed border-[var(--input-border-color)] rounded-md transition-colors">
                                <textarea
                                    class="block w-full border-none focus:ring-0 p-0 placeholder:text-gray-400 text-base bg-transparent resize-none"
                                    id="information" name="information" placeholder="在此处粘贴或输入文本，或拖拽文件到此区域"
                                    rows="8"></textarea>
                                <input type="file" id="file-input" class="hidden" multiple
                                    accept=".jpg,.jpeg,.png,.txt,.md,.csv,.docx,.pdf,.xlsx,.pptx">
                                <button type="button" id="upload-button"
                                    class="absolute bottom-2 right-2 text-gray-400 hover:text-[var(--primary-color)] transition-colors p-1 bg-white/50 backdrop-blur-sm rounded-full">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13">
                                        </path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <!-- 文件上传列表 -->
                        <div id="file-list" class="space-y-3"></div>

                        <div class="flex justify-end pt-2">
                            <button
                                class="w-full sm:w-auto inline-flex items-center justify-center px-6 py-2.5 border border-transparent text-base font-semibold rounded-md text-white bg-[var(--primary-color)] hover:bg-opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[var(--primary-color)] transition-all shadow-lg"
                                type="submit">
                                生成清单
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- 全屏加载/消息提示模态框 -->
    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center z-[99] hidden">
        <div class="bg-white rounded-lg shadow-xl p-8 text-center max-w-sm w-full mx-4">
            <div id="modal-loader" class="flex justify-center items-center mb-4">
                <div class="loader"></div>
            </div>
            <h3 id="modal-title" class="text-lg font-medium text-gray-900">正在生成清单...</h3>
            <p id="modal-message" class="text-sm text-gray-500 mt-2"></p>
            <button id="modal-close-button"
                class="mt-6 w-full rounded-md bg-gray-200 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-300 hidden">关闭</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('main-form');
            const dropZone = document.getElementById('drop-zone');
            const fileInput = document.getElementById('file-input');
            const uploadButton = document.getElementById('upload-button');
            const fileListContainer = document.getElementById('file-list');

            const modal = document.getElementById('modal');
            const modalLoader = document.getElementById('modal-loader');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalCloseButton = document.getElementById('modal-close-button');

            // 这是一个示例 JWT 令牌，实际应用中应从登录认证流程中动态获取
            const jwtToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3ODUyNDU3NzUsImlhdCI6MTc1MzcwOTc3NSwiand0VXNlcklkIjoxfQ.JYvVjxRbWuwXMHTwowExQIL1liYMDhLuwHQ668-PvAo';

            let uploadedFiles = []; // 存储已上传成功的文件信息 {id, name, url}

            // --- 文件上传相关逻辑 ---
            uploadButton.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('drag-over'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('drag-over'), false);
            });

            dropZone.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files), false);

            function handleFiles(files) {
                [...files].forEach(uploadFile);
            }

            function uploadFile(file) {
                const url = 'http://47.98.215.181:8010/llmcenter/v1/files/upload';
                const formData = new FormData();
                formData.append('file', file);

                const tempFileId = `file-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
                const fileElement = createFileElement(tempFileId, file.name);
                fileListContainer.appendChild(fileElement);

                const xhr = new XMLHttpRequest();
                xhr.open('POST', url, true);
                xhr.setRequestHeader('Authorization', `Bearer ${jwtToken}`);

                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = (e.loaded / e.total) * 100;
                        updateProgress(tempFileId, Math.round(percent));
                    }
                });

                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            try {
                                const response = JSON.parse(xhr.responseText);
                                if (response.code === 0 && response.data) {
                                    handleUploadSuccess(tempFileId, response.data);
                                } else {
                                    const errorMessage = response.msg || '响应格式不正确';
                                    handleUploadError(tempFileId, errorMessage);
                                }
                            } catch (error) {
                                handleUploadError(tempFileId, '无法解析服务器响应');
                            }
                        } else {
                            let errorMessage = `HTTP错误: ${xhr.status}`;
                            try {
                                const errorResponse = JSON.parse(xhr.responseText);
                                if (errorResponse.error && errorResponse.error.message) {
                                    errorMessage = errorResponse.error.message;
                                }
                            } catch (e) {
                                // Response body is not JSON or is empty
                            }
                            handleUploadError(tempFileId, errorMessage);
                        }
                    }
                };

                xhr.onerror = function () {
                    handleUploadError(tempFileId, '网络请求失败');
                };

                xhr.send(formData);
            }

            function createFileElement(tempFileId, fileName) {
                const el = document.createElement('div');
                el.id = tempFileId;
                el.className = 'file-item p-3 rounded-lg border border-gray-200 bg-white shadow-sm';
                el.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3 overflow-hidden">
                            <svg class="w-6 h-6 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            <span class="text-sm font-medium text-gray-800 truncate">${fileName}</span>
                        </div>
                        <button type="button" class="remove-btn hidden text-gray-400 hover:text-[var(--error-color)]">
                           <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                    <div class="mt-2">
                        <div class="progress-bar-bg">
                            <div class="progress-bar" style="width: 0%"></div>
                        </div>
                        <div class="status-text text-xs text-right text-gray-500 mt-1"></div>
                    </div>
                `;
                el.querySelector('.remove-btn').addEventListener('click', (e) => {
                    const backendId = el.dataset.backendId;
                    if (backendId) {
                        uploadedFiles = uploadedFiles.filter(f => f.id !== backendId);
                    }
                    el.remove();
                });
                return el;
            }

            function updateProgress(tempFileId, percent) {
                const fileElement = document.getElementById(tempFileId);
                if (fileElement) {
                    fileElement.querySelector('.progress-bar').style.width = `${percent}%`;
                }
            }

            function handleUploadSuccess(tempFileId, responseData) {
                const fileElement = document.getElementById(tempFileId);
                if (fileElement) {
                    fileElement.dataset.backendId = responseData.file_id;
                    fileElement.querySelector('.progress-bar').style.width = '100%';
                    fileElement.querySelector('.progress-bar').classList.remove('bg-[var(--primary-color)]');
                    fileElement.querySelector('.progress-bar').classList.add('bg-[var(--success-color)]');
                    fileElement.querySelector('.status-text').textContent = responseData.message || '上传成功';
                    fileElement.querySelector('.remove-btn').classList.remove('hidden');
                    uploadedFiles.push({ id: responseData.file_id, name: responseData.file_name, url: responseData.url || '' });
                }
            }

            function handleUploadError(tempFileId, message) {
                const fileElement = document.getElementById(tempFileId);
                if (fileElement) {
                    fileElement.querySelector('.progress-bar').style.width = '100%';
                    fileElement.querySelector('.progress-bar').classList.remove('bg-[var(--primary-color)]');
                    fileElement.querySelector('.progress-bar').classList.add('bg-[var(--error-color)]');
                    fileElement.querySelector('.status-text').textContent = `上传失败: ${message}`;
                    fileElement.querySelector('.status-text').classList.add('text-[var(--error-color)]');
                    fileElement.querySelector('.remove-btn').classList.remove('hidden');
                }
            }

            // --- 表单提交与SSE逻辑 ---
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                generateChecklist();
            });

            async function generateChecklist() {
                const documentType = document.getElementById('document-type').value;
                if (!documentType) {
                    showModalMessage('错误', '请选择一个公文类型。', true);
                    return;
                }
                showModalMessage('正在生成清单...', '', false);

                // 清除旧的 localStorage 数据，以防万一
                localStorage.removeItem('docuCraftChecklist');
                localStorage.removeItem('docuCraftConversationId');

                const payload = {
                    conversation_id: "",
                    documenttype: documentType,
                    information: document.getElementById('information').value,
                    requests: document.getElementById('requests').value,
                    use_knowledge_base: false,
                    knowledge_base_id: "",
                    references: uploadedFiles.map(f => ({ type: 'file', file_id: f.url }))
                };

                try {
                    const response = await fetch('http://47.98.215.181:8010/llmcenter/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${jwtToken}`
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const message = errorData.error?.message || `HTTP 错误: ${response.status}`;
                        throw new Error(message);
                    }

                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let buffer = '';
                    let interruptHandled = false;

                    while (true) {
                        const { value, done } = await reader.read();
                        if (done) break;

                        buffer += decoder.decode(value, { stream: true });
                        const parts = buffer.split('\n\n');
                        buffer = parts.pop(); // Keep the last, possibly incomplete, part

                        for (const part of parts) {
                            if (interruptHandled) continue;
                            const eventLine = part.split('\n').find(line => line.startsWith('event:'));
                            const dataLine = part.split('\n').find(line => line.startsWith('data:'));

                            if (eventLine && dataLine) {
                                const eventType = eventLine.substring(6).trim();
                                const dataJson = dataLine.substring(5).trim();

                                try {
                                    const data = JSON.parse(dataJson);

                                    // **MODIFICATION**: 只要数据中包含 conversation_id，就立即存储
                                    if (data.conversation_id) {
                                        localStorage.setItem('docuCraftConversationId', data.conversation_id);
                                        console.log('已捕获并存储 conversation_id:', data.conversation_id);
                                    }

                                    if (eventType === 'interrupt') {
                                        if (data.content_type === 'document_outline' && data.content) {
                                            localStorage.setItem('docuCraftChecklist', data.content);

                                            // 确保在跳转前 conversation_id 已被存储
                                            if (localStorage.getItem('docuCraftConversationId')) {
                                                window.location.href = '2.html'; // 跳转到第二个页面
                                                interruptHandled = true;
                                                reader.cancel(); // 停止读取流
                                                return;
                                            } else {
                                                // 如果 interrupt 事件本身不含 ID，继续等待下一个事件
                                                console.warn('收到 interrupt，但尚未捕获 conversation_id，将继续监听...');
                                            }
                                        }
                                    }
                                } catch (e) {
                                    console.error("解析流数据失败:", e, "原始数据:", dataJson);
                                }
                            }
                        }
                    }
                    if (!interruptHandled) {
                        showModalMessage('生成失败', '未能从服务器获取有效的内容清单。', true);
                    }

                } catch (error) {
                    console.error('Fetch Error:', error);
                    showModalMessage('请求失败', error.message, true);
                }
            }

            // --- 模态框控制 ---
            function showModalMessage(title, message, showCloseButton) {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalCloseButton.style.display = showCloseButton ? 'block' : 'none';
                modalLoader.style.display = showCloseButton ? 'none' : 'flex';
                modal.classList.remove('hidden');
            }

            modalCloseButton.addEventListener('click', () => {
                modal.classList.add('hidden');
            });

        });
    </script>
</body>

</html>